# 注册即产生的免费试用订单

## 逻辑

- 用户注册并创建空间后，应自动为该空间创建一条**免费试用**订单，以便主应用通过 `crm.get_space_entitlements(space_id)` 拿到权益。
- 订单数据：`crm.space_orders`
  - `space_id` = 新创建的空间 ID
  - `sku_id` = 权益包编码为 `FREE_TRIAL` 的 id（执行 `crm-schema.sql` 时已插入）
  - `status` = `'active'`
  - `started_at` = now()
  - `expires_at` = 按业务设定（如试用 30 天则为 now() + interval '30 days'），或 NULL 表示长期
  - `source` = `'registration'`

## 实现位置（二选一）

1. **主应用（Vouchap / vouchap-web）**  
   在“创建空间”成功的回调里，用 Supabase 客户端插入 `crm.space_orders` 一条记录。  
   需要主应用使用对 `crm` 表有写权限的 key（如 service_role，仅在后端或 Edge Function 使用），或通过 Edge Function 代为插入。

2. **Supabase Edge Function + Database Webhook**  
   在 `public.spaces` 上配置 insert 后的 webhook，触发 Edge Function，在 Function 内根据新插入的 `space.id` 查询 `crm.sku` 中 `code = 'FREE_TRIAL'` 的 id，再向 `crm.space_orders` 插入一条。

## 查询 FREE_TRIAL sku id

```sql
SELECT id FROM crm.sku WHERE code = 'FREE_TRIAL' LIMIT 1;
```

插入示例（将 `空间UUID`、`FREE_TRIAL的UUID` 替换为实际值）：

```sql
INSERT INTO crm.space_orders (space_id, sku_id, status, source)
VALUES ('空间UUID', 'FREE_TRIAL的UUID', 'active', 'registration');
```
